<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­íˆ¬ìì¦ê¶Œ KIS íˆ¬ì ê±°ì¥ ìŠ¤í¬ë¦¬ë„ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1e40af;
            --secondary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1f2937;
        }

        body {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .main-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            margin: 20px auto;
            max-width: 1600px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #1e3a8a 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .kis-logo {
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 28px;
            font-weight: bold;
            color: #fbbf24;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
            margin: 0;
        }

        .controls-section {
            background: #f8fafc;
            padding: 25px;
            border-bottom: 2px solid #e2e8f0;
        }

        .market-selection {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 2px solid #93c5fd;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .market-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .market-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .market-btn {
            background: white;
            border: 2px solid #93c5fd;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 5px;
            min-width: 120px;
            justify-content: center;
        }

        .market-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59,130,246,0.3);
            border-color: var(--secondary-color);
        }

        .market-btn.active {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
            box-shadow: 0 4px 12px rgba(59,130,246,0.4);
        }

        .investor-selection {
            background: #f8fafc;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .investor-title {
            color: var(--dark-color);
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .investor-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .investor-btn {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            text-align: center;
            min-height: 120px;
        }

        .investor-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--secondary-color);
        }

        .investor-btn.active {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            color: white;
            border-color: var(--secondary-color);
            box-shadow: 0 8px 25px rgba(59,130,246,0.4);
        }

        .investor-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .investor-name {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .investor-subtitle {
            font-size: 0.85rem;
            opacity: 0.8;
            font-weight: 500;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-custom {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary-custom {
            background: var(--primary-color);
            border: none;
            color: white;
        }

        .btn-primary-custom:hover {
            background: #1e3a8a;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(30,64,175,0.4);
        }

        .btn-success-custom {
            background: var(--success-color);
            border: none;
            color: white;
        }

        .btn-success-custom:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16,185,129,0.4);
        }

        .btn-warning-custom {
            background: var(--warning-color);
            border: none;
            color: white;
        }

        .btn-warning-custom:hover {
            background: #d97706;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245,158,11,0.4);
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            background: #fef2f2;
            color: #991b1b;
            border: 2px solid #fecaca;
        }

        .api-status.connected {
            background: #f0fdf4;
            color: #166534;
            border-color: #bbf7d0;
        }

        .summary-section {
            background: #f8fafc;
            padding: 25px;
            border-bottom: 1px solid #e2e8f0;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 4px solid var(--secondary-color);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-2px);
        }

        .summary-card h6 {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .summary-card .value {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--dark-color);
            margin: 0;
        }

        .results-section {
            padding: 30px;
        }

        .results-header {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .results-title {
            color: var(--dark-color);
            font-size: 1.5rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .results-subtitle {
            color: #6b7280;
            margin: 0;
        }

        .investor-description {
            background: #eff6ff;
            border: 1px solid #93c5fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            color: var(--primary-color);
            font-weight: 500;
        }

        .table-responsive {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .table {
            margin: 0;
            background: white;
        }

        .table thead th {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
            color: white;
            border: none;
            padding: 15px 10px;
            font-weight: 600;
            font-size: 0.875rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table thead th.group-header {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
        }

        .table tbody td {
            padding: 12px 10px;
            border-color: #f3f4f6;
            text-align: center;
            font-size: 0.875rem;
            vertical-align: middle;
        }

        .table tbody tr:hover {
            background: #f9fafb;
        }

        .grade-S { 
            background: #dbeafe; 
            color: #1e40af; 
            font-weight: bold; 
            padding: 4px 8px; 
            border-radius: 4px;
        }

        .grade-A { 
            background: #dcfce7; 
            color: #166534; 
            font-weight: bold; 
            padding: 4px 8px; 
            border-radius: 4px;
        }

        .grade-B { 
            background: #fef3c7; 
            color: #92400e; 
            font-weight: bold; 
            padding: 4px 8px; 
            border-radius: 4px;
        }

        .grade-C { 
            background: #fce7f3; 
            color: #be185d; 
            padding: 4px 8px; 
            border-radius: 4px;
        }

        .grade-D { 
            background: #fee2e2; 
            color: #dc2626; 
            padding: 4px 8px; 
            border-radius: 4px;
        }

        .positive { color: var(--success-color); font-weight: 600; }
        .negative { color: var(--danger-color); font-weight: 600; }
        .neutral { color: #6b7280; }

        .recommendation-buy { 
            background: #dcfce7; 
            color: #166534; 
            font-weight: bold; 
            padding: 6px 12px; 
            border-radius: 6px; 
        }

        .recommendation-hold { 
            background: #fef3c7; 
            color: #92400e; 
            font-weight: bold; 
            padding: 6px 12px; 
            border-radius: 6px; 
        }

        .recommendation-sell { 
            background: #fee2e2; 
            color: #dc2626; 
            font-weight: bold; 
            padding: 6px 12px; 
            border-radius: 6px; 
        }

        .rank-badge {
            background: var(--secondary-color);
            color: white;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-bottom: 4px;
            display: inline-block;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .modal-content {
            border-radius: 12px;
            border: none;
        }

        .modal-header {
            background: var(--primary-color);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .btn-close {
            filter: invert(1);
        }

        .search-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .kis-logo {
                position: static;
                transform: none;
                margin-bottom: 10px;
            }
            
            .header h1 {
                font-size: 1.75rem;
            }
            
            .investor-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .investor-btn {
                min-height: 100px;
                padding: 15px 10px;
            }
            
            .investor-icon {
                font-size: 2rem;
            }
            
            .investor-name {
                font-size: 0.9rem;
            }
            
            .market-buttons {
                gap: 5px;
            }
            
            .market-btn {
                min-width: 100px;
                padding: 8px 12px;
                font-size: 0.875rem;
            }
            
            .control-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn-custom {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- í—¤ë” -->
            <div class="header">
                <div class="kis-logo">KIS</div>
                <h1><i class="fas fa-chart-line"></i> í•œêµ­íˆ¬ìì¦ê¶Œ íˆ¬ì ê±°ì¥ ìŠ¤í¬ë¦¬ë„ˆ</h1>
                <p>KIS Developers API ê¸°ë°˜ Â· ì›Œë Œ ë²„í•ë¶€í„° ì¡°ì—˜ ê·¸ë¦°ë¸”ë¼íŠ¸ê¹Œì§€ 6ëŒ€ íˆ¬ì ì² í•™ìœ¼ë¡œ ì¢…ëª© ë¶„ì„</p>
            </div>

            <!-- ì»¨íŠ¸ë¡¤ ì„¹ì…˜ -->
            <div class="controls-section">
                <!-- ì‹œì¥ ì„ íƒ -->
                <div class="market-selection">
                    <h5 class="market-title">
                        <i class="fas fa-globe-americas"></i> íˆ¬ì ì‹œì¥ ì„ íƒ (KIS Developers ì§€ì›)
                    </h5>
                    <p class="text-center text-muted mb-3">êµ­ë‚´ì£¼ì‹ê³¼ í•´ì™¸ì£¼ì‹ì„ í•œêµ­íˆ¬ìì¦ê¶Œ APIë¡œ ì‹¤ì‹œê°„ ë¶„ì„</p>
                    <div class="market-buttons">
                        <button class="market-btn active" data-market="all" onclick="selectMarket('all')">
                            <span>ğŸŒ</span> ì „ì²´ ì‹œì¥
                        </button>
                        <button class="market-btn" data-market="domestic" onclick="selectMarket('domestic')">
                            <span>ğŸ‡°ğŸ‡·</span> êµ­ë‚´ì£¼ì‹
                        </button>
                        <button class="market-btn" data-market="us" onclick="selectMarket('us')">
                            <span>ğŸ‡ºğŸ‡¸</span> ë¯¸êµ­ì£¼ì‹
                        </button>
                        <button class="market-btn" data-market="global" onclick="selectMarket('global')">
                            <span>ğŸŒ</span> í•´ì™¸ì£¼ì‹
                        </button>
                    </div>
                </div>

                <!-- íˆ¬ìì ì„ íƒ -->
                <div class="investor-selection">
                    <h5 class="investor-title">
                        <i class="fas fa-users"></i> íˆ¬ì ê±°ì¥ ì„ íƒ
                    </h5>
                    <p class="text-center text-muted mb-3">í´ë¦­í•˜ì—¬ í•´ë‹¹ íˆ¬ì ì² í•™ ê¸°ì¤€ìœ¼ë¡œ ì¢…ëª©ì„ ë¶„ì„í•˜ì„¸ìš”</p>
                    <div class="investor-buttons">
                        <button class="investor-btn active" data-investor="buffett" onclick="selectInvestor('buffett')">
                            <div class="investor-icon">ğŸ‘‘</div>
                            <div class="investor-name">ì›Œë Œ ë²„í•</div>
                            <div class="investor-subtitle">ê°€ì¹˜íˆ¬ì</div>
                        </button>
                        <button class="investor-btn" data-investor="lynch" onclick="selectInvestor('lynch')">
                            <div class="investor-icon">ğŸš€</div>
                            <div class="investor-name">í”¼í„° ë¦°ì¹˜</div>
                            <div class="investor-subtitle">ì„±ì¥ì£¼</div>
                        </button>
                        <button class="investor-btn" data-investor="graham" onclick="selectInvestor('graham')">
                            <div class="investor-icon">ğŸ“š</div>
                            <div class="investor-name">ë²¤ì €ë¯¼ ê·¸ë ˆì´ì—„</div>
                            <div class="investor-subtitle">ë”¥ë°¸ë¥˜</div>
                        </button>
                        <button class="investor-btn" data-investor="fisher" onclick="selectInvestor('fisher')">
                            <div class="investor-icon">ğŸ”¬</div>
                            <div class="investor-name">í•„ë¦½ í”¼ì…”</div>
                            <div class="investor-subtitle">ì„±ì¥ ê°€ì¹˜</div>
                        </button>
                        <button class="investor-btn" data-investor="munger" onclick="selectInvestor('munger')">
                            <div class="investor-icon">ğŸ¯</div>
                            <div class="investor-name">ì°°ë¦¬ ë©ê±°</div>
                            <div class="investor-subtitle">ìš°ëŸ‰ê¸°ì—…</div>
                        </button>
                        <button class="investor-btn" data-investor="greenblatt" onclick="selectInvestor('greenblatt')">
                            <div class="investor-icon">ğŸª„</div>
                            <div class="investor-name">ì¡°ì—˜ ê·¸ë¦°ë¸”ë¼íŠ¸</div>
                            <div class="investor-subtitle">ë§ˆë²•ê³µì‹</div>
                        </button>
                    </div>
                </div>

                <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ -->
                <div class="control-buttons">
                    <button class="btn btn-primary-custom" onclick="openKisApiModal()">
                        <i class="fas fa-link"></i> KIS API ì—°ë™
                    </button>
                    <button class="btn btn-success-custom" id="updateBtn" onclick="updateAllPrices()">
                        <i class="fas fa-sync-alt"></i> ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
                    </button>
                    <button class="btn btn-warning-custom" onclick="showInvestmentCriteria()">
                        <i class="fas fa-book"></i> íˆ¬ì ê¸°ì¤€
                    </button>
                    <button class="btn btn-primary-custom" onclick="exportData()">
                        <i class="fas fa-download"></i> ë°ì´í„° ë‚´ë³´ë‚´ê¸°
                    </button>
                    <div class="api-status" id="apiStatus">
                        <span class="status-icon">ğŸ”´</span>
                        <span>KIS API ì—°ê²° ì•ˆë¨</span>
                    </div>
                </div>
            </div>

            <!-- ìš”ì•½ ì„¹ì…˜ -->
            <div class="summary-section">
                <div class="search-section">
                    <div class="input-group" style="max-width: 300px;">
                        <input type="text" class="form-control" id="stockSearch" placeholder="ì¢…ëª©ëª… ë˜ëŠ” ì½”ë“œ ê²€ìƒ‰...">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchStocks()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <select class="form-select" style="max-width: 200px;" id="limitSelect" onchange="updateResults()">
                        <option value="10">ìƒìœ„ 10ê°œ</option>
                        <option value="20">ìƒìœ„ 20ê°œ</option>
                        <option value="50">ìƒìœ„ 50ê°œ</option>
                        <option value="0">ì „ì²´ ë³´ê¸°</option>
                    </select>
                </div>

                <div class="summary-cards" id="summaryCards">
                    <div class="summary-card">
                        <h6>ë¶„ì„ ì¢…ëª© ìˆ˜</h6>
                        <div class="value" id="totalStocks">0</div>
                    </div>
                    <div class="summary-card">
                        <h6>í‘œì‹œ ì¤‘ì¸ ì¢…ëª©</h6>
                        <div class="value" id="displayedStocks">0</div>
                    </div>
                    <div class="summary-card">
                        <h6>Sê¸‰ ì¢…ëª©</h6>
                        <div class="value" id="sGradeStocks">0</div>
                    </div>
                    <div class="summary-card">
                        <h6>ë§¤ìˆ˜ ì¶”ì²œ</h6>
                        <div class="value" id="buyRecommendations">0</div>
                    </div>
                    <div class="summary-card">
                        <h6>í˜„ì¬ ì‹œì¥</h6>
                        <div class="value" id="currentMarket">ğŸŒ ì „ì²´</div>
                    </div>
                    <div class="summary-card">
                        <h6>í‰ê·  ì¢…í•©ì ìˆ˜</h6>
                        <div class="value" id="avgScore">0.0</div>
                    </div>
                </div>
            </div>

            <!-- ê²°ê³¼ ì„¹ì…˜ -->
            <div class="results-section">
                <div class="results-header">
                    <h2 class="results-title" id="resultsTitle">
                        <span>ğŸ‘‘</span> ì›Œë Œ ë²„í• ê¸°ì¤€ ìƒìœ„ 10ê°œ ì¶”ì²œ ì¢…ëª©
                    </h2>
                    <p class="results-subtitle" id="resultsSubtitle">ì¢…í•©ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì„ ë³„ëœ ìµœê³ ì˜ íˆ¬ì ê¸°íšŒ</p>
                    <div class="investor-description" id="investorDescription">
                        <strong>ì›Œë Œ ë²„í• ì² í•™:</strong> ê²½ì œì  í•´ì + ë›°ì–´ë‚œ ê²½ì˜ì§„ + ì¬ë¬´ê±´ì „ì„± + í•©ë¦¬ì  ê°€ê²©
                    </div>
                </div>

                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
                    </div>
                    <p class="mt-3">íˆ¬ì ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>

                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th rowspan="2">ìˆœìœ„</th>
                                <th rowspan="2">ì¢…ëª©ëª…</th>
                                <th rowspan="2">ì‹œì¥</th>
                                <th rowspan="2">ì„¹í„°</th>
                                <th rowspan="2">í˜„ì¬ê°€</th>
                                <th class="group-header" colspan="4">ì¬ë¬´ê±´ì „ì„±</th>
                                <th class="group-header" colspan="4">ìˆ˜ìµì„±ì§€í‘œ</th>
                                <th class="group-header" colspan="3">ì„±ì¥ì„±</th>
                                <th class="group-header" colspan="3">ë°¸ë¥˜ì—ì´ì…˜</th>
                                <th class="group-header" colspan="3">íˆ¬ìí‰ê°€</th>
                                <th rowspan="2">ì•¡ì…˜</th>
                            </tr>
                            <tr>
                                <th>ë¶€ì±„ë¹„ìœ¨</th>
                                <th>ìœ ë™ë¹„ìœ¨</th>
                                <th>ìê¸°ìë³¸ë¹„ìœ¨</th>
                                <th>ì‹ ìš©ë“±ê¸‰</th>
                                <th>ROE</th>
                                <th>ROA</th>
                                <th>ì˜ì—…ì´ìµë¥ </th>
                                <th>ìˆœì´ìµë¥ </th>
                                <th>ë§¤ì¶œì„±ì¥ë¥ </th>
                                <th>ìˆœì´ìµì„±ì¥ë¥ </th>
                                <th>EPSì„±ì¥ë¥ </th>
                                <th>PER</th>
                                <th>PBR</th>
                                <th>ë°°ë‹¹ìˆ˜ìµë¥ </th>
                                <th>ì¢…í•©ì ìˆ˜</th>
                                <th>ë“±ê¸‰</th>
                                <th>íˆ¬ìì˜ê²¬</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody">
                            <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- KIS API ì„¤ì • ëª¨ë‹¬ -->
    <div class="modal fade" id="kisApiModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-link"></i> í•œêµ­íˆ¬ìì¦ê¶Œ API ì—°ë™ ì„¤ì •
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> KIS Developers API ì •ë³´</h6>
                        <ul class="mb-0">
                            <li><strong>ì„œë¹„ìŠ¤ ì‹ ì²­:</strong> <a href="https://apiportal.koreainvestment.com" target="_blank">apiportal.koreainvestment.com</a></li>
                            <li><strong>ì§€ì› ê¸°ëŠ¥:</strong> REST API, WebSocket ì‹¤ì‹œê°„ ì‹œì„¸</li>
                            <li><strong>ì¸ì¦ ë°©ì‹:</strong> OAuth 2.0 (App Key + App Secret)</li>
                            <li><strong>ì§€ì› ìƒí’ˆ:</strong> êµ­ë‚´ì£¼ì‹, í•´ì™¸ì£¼ì‹, ì„ ë¬¼ì˜µì…˜</li>
                        </ul>
                    </div>

                    <form id="kisApiForm">
                        <div class="mb-3">
                            <label class="form-label">í™˜ê²½ ì„ íƒ</label>
                            <select class="form-select" id="kisEnvironment">
                                <option value="vps">ëª¨ì˜íˆ¬ì (VPS)</option>
                                <option value="real">ì‹¤ì „íˆ¬ì (REAL)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">App Key *</label>
                            <input type="password" class="form-control" id="kisAppKey" 
                                   placeholder="KIS Developersì—ì„œ ë°œê¸‰ë°›ì€ App Key">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">App Secret *</label>
                            <input type="password" class="form-control" id="kisAppSecret" 
                                   placeholder="KIS Developersì—ì„œ ë°œê¸‰ë°›ì€ App Secret">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ê³„ì¢Œë²ˆí˜¸ (ì„ íƒ)</label>
                            <input type="text" class="form-control" id="kisAccountNo" 
                                   placeholder="ì¢…í•©ê³„ì¢Œë²ˆí˜¸ 8ìë¦¬-ìƒí’ˆì½”ë“œ 2ìë¦¬ (ì˜ˆ: 50000000-01)">
                        </div>

                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" onclick="testKisConnection()">
                                <i class="fas fa-plug"></i> ì—°ê²° í…ŒìŠ¤íŠ¸
                            </button>
                            <button type="button" class="btn btn-success" onclick="saveKisConfig()">
                                <i class="fas fa-save"></i> ì„¤ì • ì €ì¥
                            </button>
                            <a href="https://apiportal.koreainvestment.com" target="_blank" class="btn btn-outline-primary">
                                <i class="fas fa-external-link-alt"></i> KIS í¬í„¸
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- íˆ¬ì ê¸°ì¤€ ëª¨ë‹¬ -->
    <div class="modal fade" id="criteriaModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-book"></i> íˆ¬ì ê±°ì¥ë³„ ë¶„ì„ ê¸°ì¤€
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6>ğŸ‘‘ ì›Œë Œ ë²„í• - ê°€ì¹˜íˆ¬ìì˜ í™©ì œ</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>íˆ¬ì ì² í•™:</strong> "í›Œë¥­í•œ ê¸°ì—…ì„ í•©ë¦¬ì ì¸ ê°€ê²©ì— ì‚¬ì„œ ì˜ì›íˆ ë³´ìœ í•˜ë¼"</p>
                                    <ul>
                                        <li>ê²½ì œì  í•´ì: ROE 15%â†‘, ì§€ì†ì ì¸ ì„±ì¥</li>
                                        <li>ë›°ì–´ë‚œ ê²½ì˜ì§„: ë†’ì€ ìê¸°ìë³¸ë¹„ìœ¨, ë‚®ì€ ë¶€ì±„</li>
                                        <li>ì¬ë¬´ê±´ì „ì„±: ìœ ë™ë¹„ìœ¨ 2.0â†‘, ì•ˆì •ì  í˜„ê¸ˆíë¦„</li>
                                        <li>í•©ë¦¬ì  ê°€ê²©: PER 20ë°° ì´í•˜, ì•ˆì „ë§ˆì§„</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6>ğŸš€ í”¼í„° ë¦°ì¹˜ - ì„±ì¥ì£¼ íˆ¬ìì˜ ëŒ€ê°€</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>íˆ¬ì ì² í•™:</strong> "ë‹¹ì‹ ì´ ì´í•´í•˜ëŠ” íšŒì‚¬ì— íˆ¬ìí•˜ê³  PEG ë¹„ìœ¨ì„ í™œìš©í•˜ë¼"</p>
                                    <ul>
                                        <li>ì„±ì¥ì„±: PEG ë¹„ìœ¨ 1.0 ì´í•˜, ë§¤ì¶œì„±ì¥ë¥  15%â†‘</li>
                                        <li>ì†Œë¹„ì ì¹œìˆ™ë„: ì¼ìƒì—ì„œ ë°œê²¬í•  ìˆ˜ ìˆëŠ” ê¸°ì—…</li>
                                        <li>ì ì • ë°¸ë¥˜ì—ì´ì…˜: PER 25ë°° ì´í•˜</li>
                                        <li>í’ˆì§ˆ: ROE 15%â†‘, ì˜ì—…ì´ìµë¥  10%â†‘</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6>ğŸ“š ë²¤ì €ë¯¼ ê·¸ë ˆì´ì—„ - ê°€ì¹˜íˆ¬ìì˜ ì•„ë²„ì§€</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>íˆ¬ì ì² í•™:</strong> "ì•ˆì „ë§ˆì§„ì„ í™•ë³´í•˜ì—¬ Mr. Marketì˜ ë³€ë•ì„ ì´ìš©í•˜ë¼"</p>
                                    <ul>
                                        <li>ì €í‰ê°€: PER 15ë°° ì´í•˜, PBR 2.5ë°° ì´í•˜</li>
                                        <li>ì•ˆì „ì„±: ìœ ë™ë¹„ìœ¨ 2.0â†‘, ë¶€ì±„ë¹„ìœ¨ 30% ì´í•˜</li>
                                        <li>ë°°ë‹¹: ë°°ë‹¹ìˆ˜ìµë¥  2%â†‘, ì•ˆì •ì  ë°°ë‹¹</li>
                                        <li>ì•ˆì „ë§ˆì§„: ë‚´ì¬ê°€ì¹˜ ëŒ€ë¹„ 30% ì´ìƒ í• ì¸</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6>ğŸ”¬ í•„ë¦½ í”¼ì…” - ì„±ì¥ ê°€ì¹˜ íˆ¬ì</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>íˆ¬ì ì² í•™:</strong> "ë›°ì–´ë‚œ ê¸°ì—…ì„ ì°¾ì•„ ì¥ê¸°ê°„ ë³´ìœ í•˜ë©° ì„±ì¥ ê³¼ì‹¤ì„ ëˆ„ë ¤ë¼"</p>
                                    <ul>
                                        <li>í˜ì‹ ì„±: ë†’ì€ ë§ˆì§„ìœ¨, R&D íˆ¬ì</li>
                                        <li>ì„±ì¥ì„±: ë§¤ì¶œ/ìˆœì´ìµ ì„±ì¥ë¥  15%â†‘</li>
                                        <li>ê²½ì˜ì§„: ROE 20%â†‘, ë›°ì–´ë‚œ ê²½ì˜ ëŠ¥ë ¥</li>
                                        <li>15ê°œ í¬ì¸íŠ¸: ë§¤ì¶œì„±ì¥, ì´ìµì„±ì¥, ì—°êµ¬ê°œë°œ ë“±</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6>ğŸ¯ ì°°ë¦¬ ë©ê±° - ë²„í•ì˜ ë™ë°˜ì</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>íˆ¬ì ì² í•™:</strong> "ê°„ë‹¨í•˜ê³  ì´í•´í•˜ê¸° ì‰¬ìš´ ë¹„ì¦ˆë‹ˆìŠ¤ì— í•©ë¦¬ì  ê°€ê²©ìœ¼ë¡œ íˆ¬ìí•˜ë¼"</p>
                                    <ul>
                                        <li>ë‹¨ìˆœì„±: ì´í•´í•˜ê¸° ì‰¬ìš´ ë¹„ì¦ˆë‹ˆìŠ¤</li>
                                        <li>ê²½ìŸìš°ìœ„: ROE 20%â†‘, ê°•ë ¥í•œ ë¸Œëœë“œ</li>
                                        <li>í•©ë¦¬ì  ê°€ê²©: PER 18ë°° ì´í•˜</li>
                                        <li>ë©˜íƒˆ ëª¨ë¸: ë‹¤ê°ë„ ë¶„ì„, ì—­ì‚°ì  ì‚¬ê³ </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6>ğŸª„ ì¡°ì—˜ ê·¸ë¦°ë¸”ë¼íŠ¸ - ë§ˆë²•ê³µì‹ì˜ ì°½ì‹œì</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>íˆ¬ì ì² í•™:</strong> "ì¢‹ì€ íšŒì‚¬ë¥¼ ì‹¼ ê°€ê²©ì— ì‚¬ëŠ” ê²ƒì´ ìˆ˜ìµì˜ í•µì‹¬ì´ë‹¤"</p>
                                    <ul>
                                        <li>ìë³¸ìˆ˜ìµë¥ : ROA 15%â†‘</li>
                                        <li>ì´ìµìˆ˜ìµë¥ : 1/PER 10%â†‘ (PER 10ë°° ì´í•˜)</li>
                                        <li>ë§ˆë²•ê³µì‹: ROA ìˆœìœ„ + ì´ìµìˆ˜ìµë¥  ìˆœìœ„</li>
                                        <li>ì‹œìŠ¤í…œì  íˆ¬ì: ê°ì • ë°°ì œ, ê¸°ê³„ì  ì ‘ê·¼</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì•Œë¦¼ í† ìŠ¤íŠ¸ -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="alertToast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">ì•Œë¦¼</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentInvestor = 'buffett';
        let currentMarket = 'all';
        let currentLimit = 10;
        let currentStocks = [];
        let isKisConnected = false;

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            loadStocks();
            setupEventListeners();
        });

        function setupEventListeners() {
            // ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸
            document.getElementById('stockSearch').addEventListener('input', debounce(searchStocks, 500));
            
            // ì—”í„°í‚¤ ê²€ìƒ‰
            document.getElementById('stockSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchStocks();
                }
            });

            // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
            document.addEventListener('keydown', function(e) {
                // ìˆ«ì í‚¤ë¡œ íˆ¬ìì ì„ íƒ (1-6)
                if (e.key >= '1' && e.key <= '6' && !e.ctrlKey && !e.altKey) {
                    const investors = ['buffett', 'lynch', 'graham', 'fisher', 'munger', 'greenblatt'];
                    selectInvestor(investors[parseInt(e.key) - 1]);
                }
                
                // Ctrl+Uë¡œ ì—…ë°ì´íŠ¸
                if (e.ctrlKey && e.key === 'u') {
                    e.preventDefault();
                    updateAllPrices();
                }
            });
        }

        function selectMarket(market) {
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.market-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-market="${market}"]`).classList.add('active');
            
            currentMarket = market;
            loadStocks();
            showToast('ì‹œì¥ ì„ íƒ', `${getMarketText(market)} ì‹œì¥ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }

        function selectInvestor(investor) {
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.investor-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-investor="${investor}"]`).classList.add('active');
            
            currentInvestor = investor;
            loadStocks();
            
            const investorNames = {
                'buffett': 'ì›Œë Œ ë²„í•',
                'lynch': 'í”¼í„° ë¦°ì¹˜', 
                'graham': 'ë²¤ì €ë¯¼ ê·¸ë ˆì´ì—„',
                'fisher': 'í•„ë¦½ í”¼ì…”',
                'munger': 'ì°°ë¦¬ ë©ê±°',
                'greenblatt': 'ì¡°ì—˜ ê·¸ë¦°ë¸”ë¼íŠ¸'
            };
            
            showToast('íˆ¬ìì ì„ íƒ', `${investorNames[investor]} ê¸°ì¤€ìœ¼ë¡œ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.`, 'success');
        }

        function updateResults() {
            currentLimit = parseInt(document.getElementById('limitSelect').value);
            loadStocks();
        }

        function searchStocks() {
            const searchTerm = document.getElementById('stockSearch').value.trim();
            if (searchTerm) {
                const filteredStocks = currentStocks.filter(stock => 
                    stock.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    stock.code.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    stock.sector.toLowerCase().includes(searchTerm.toLowerCase())
                );
                displayStocks(filteredStocks);
                updateSummary(filteredStocks);
            } else {
                const displayStocks = currentLimit > 0 ? currentStocks.slice(0, currentLimit) : currentStocks;
                displayStocks(displayStocks);
                updateSummary(displayStocks);
            }
        }

        async function loadStocks() {
            try {
                showLoading(true);
                
                const response = await fetch(`/api/stocks?style=${currentInvestor}&market=${currentMarket}&limit=${currentLimit}`);
                const data = await response.json();
                
                if (data.success) {
                    currentStocks = data.stocks;
                    displayStocks(currentStocks);
                    updateSummary(currentStocks, data.summary);
                    updateResultsHeader(data.strategy);
                } else {
                    showToast('ì˜¤ë¥˜', data.message || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
                }
            } catch (error) {
                console.error('Load stocks error:', error);
                showToast('ì˜¤ë¥˜', 'ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
            } finally {
                showLoading(false);
            }
        }

        function displayStocks(stocks) {
            const tbody = document.getElementById('stockTableBody');
            
            if (!stocks || stocks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="21" class="text-center py-5 text-muted">
                            <i class="fas fa-search fa-3x mb-3"></i>
                            <p>í‘œì‹œí•  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = '';
            
            stocks.forEach((stock, index) => {
                const score = stock.investment_score;
                const marketInfo = getMarketInfo(stock.market);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="rank-badge">#${index + 1}</div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center justify-content-center">
                            <span class="me-2">${marketInfo.flag}</span>
                            <div>
                                <strong>${stock.name}</strong><br>
                                <small class="text-muted">${stock.code}</small>
                            </div>
                        </div>
                    </td>
                    <td><small>${marketInfo.name}</small></td>
                    <td>${stock.sector}</td>
                    <td>${formatPrice(stock.current_price, stock.currency)}</td>
                    <td class="${getColorClass(stock.debt_ratio, 'debt')}">${stock.debt_ratio.toFixed(1)}%</td>
                    <td class="${getColorClass(stock.current_ratio, 'current')}">${stock.current_ratio.toFixed(1)}</td>
                    <td class="${getColorClass(stock.equity_ratio, 'equity')}">${stock.equity_ratio.toFixed(1)}%</td>
                    <td>${stock.credit_rating}</td>
                    <td class="${getColorClass(stock.roe, 'roe')}">${stock.roe.toFixed(1)}%</td>
                    <td class="${getColorClass(stock.roa, 'roa')}">${stock.roa.toFixed(1)}%</td>
                    <td>${stock.operating_margin.toFixed(1)}%</td>
                    <td>${stock.profit_margin.toFixed(1)}%</td>
                    <td class="${getColorClass(stock.revenue_growth, 'growth')}">${stock.revenue_growth.toFixed(1)}%</td>
                    <td class="${getColorClass(stock.profit_growth, 'growth')}">${stock.profit_growth.toFixed(1)}%</td>
                    <td>${stock.eps_growth.toFixed(1)}%</td>
                    <td class="${getColorClass(stock.per, 'per')}">${stock.per.toFixed(1)}x</td>
                    <td class="${getColorClass(stock.pbr, 'pbr')}">${stock.pbr.toFixed(1)}x</td>
                    <td>${stock.dividend_yield.toFixed(1)}%</td>
                    <td><strong>${score.total_score.toFixed(1)}</strong></td>
                    <td><span class="grade-${score.grade}">${score.grade}ê¸‰</span></td>
                    <td><span class="recommendation-${getRecommendationClass(score.recommendation)}">${score.recommendation}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="updateSinglePrice('${stock.code}')">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateSummary(stocks, summaryData) {
            if (summaryData) {
                document.getElementById('totalStocks').textContent = summaryData.total_stocks;
                document.getElementById('displayedStocks').textContent = summaryData.displayed_stocks;
                document.getElementById('sGradeStocks').textContent = summaryData.s_grade_stocks;
                document.getElementById('buyRecommendations').textContent = summaryData.buy_recommendations;
                document.getElementById('currentMarket').textContent = summaryData.current_market;
                document.getElementById('avgScore').textContent = summaryData.avg_score;
            } else if (stocks) {
                const sGradeCount = stocks.filter(s => s.investment_score.grade === 'S').length;
                const buyCount = stocks.filter(s => ['ì ê·¹ë§¤ìˆ˜', 'ë§¤ìˆ˜'].includes(s.investment_score.recommendation)).length;
                const avgScore = stocks.length > 0 ? 
                    (stocks.reduce((sum, s) => sum + s.investment_score.total_score, 0) / stocks.length).toFixed(1) : 0;
                
                document.getElementById('totalStocks').textContent = currentStocks.length;
                document.getElementById('displayedStocks').textContent = stocks.length;
                document.getElementById('sGradeStocks').textContent = sGradeCount;
                document.getElementById('buyRecommendations').textContent = buyCount;
                document.getElementById('currentMarket').textContent = getMarketText(currentMarket);
                document.getElementById('avgScore').textContent = avgScore;
            }
        }

        function updateResultsHeader(strategy) {
            const limitText = currentLimit > 0 ? `ìƒìœ„ ${currentLimit}ê°œ` : 'ì „ì²´';
            const marketText = getMarketText(currentMarket);
            
            document.getElementById('resultsTitle').innerHTML = 
                `<span>${strategy.icon}</span> ${strategy.name} ê¸°ì¤€ ${limitText} ì¶”ì²œ ì¢…ëª© ${marketText !== 'ğŸŒ ì „ì²´' ? '(' + marketText + ')' : ''}`;
            
            document.getElementById('resultsSubtitle').textContent = 
                `${strategy.name} íˆ¬ì ì² í•™ì„ ë°”íƒ•ìœ¼ë¡œ ë¶„ì„ëœ ìµœê³ ì˜ íˆ¬ì ê¸°íšŒ`;
            
            document.getElementById('investorDescription').innerHTML = 
                `<strong>${strategy.icon} ${strategy.name} ì² í•™:</strong> ${strategy.description}`;
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function getMarketInfo(market) {
            const marketMap = {
                'KOSPI': { name: 'KOSPI', flag: 'ğŸ‡°ğŸ‡·' },
                'KOSDAQ': { name: 'KOSDAQ', flag: 'ğŸ‡°ğŸ‡·' },
                'NYSE': { name: 'NYSE', flag: 'ğŸ‡ºğŸ‡¸' },
                'NASDAQ': { name: 'NASDAQ', flag: 'ğŸ‡ºğŸ‡¸' },
                'TSE': { name: 'TSE', flag: 'ğŸ‡¯ğŸ‡µ' },
                'SEHK': { name: 'SEHK', flag: 'ğŸ‡­ğŸ‡°' }
            };
            return marketMap[market] || { name: market, flag: 'ğŸ³ï¸' };
        }

        function getMarketText(market) {
            const texts = {
                'all': 'ğŸŒ ì „ì²´',
                'domestic': 'ğŸ‡°ğŸ‡· êµ­ë‚´',
                'us': 'ğŸ‡ºğŸ‡¸ ë¯¸êµ­', 
                'global': 'ğŸŒ í•´ì™¸'
            };
            return texts[market] || 'ğŸŒ ì „ì²´';
        }

        function formatPrice(price, currency) {
            const symbols = { 'KRW': 'â‚©', 'USD': '$', 'JPY': 'Â¥', 'HKD': 'HK$' };
            const symbol = symbols[currency] || '';
            return `${symbol}${price.toLocaleString()}`;
        }

        function getColorClass(value, type) {
            switch(type) {
                case 'debt':
                    return value <= 20 ? 'positive' : value <= 40 ? 'neutral' : 'negative';
                case 'current':
                    return value >= 2.0 ? 'positive' : value >= 1.5 ? 'neutral' : 'negative';
                case 'equity':
                    return value >= 70 ? 'positive' : value >= 60 ? 'neutral' : 'negative';
                case 'roe':
                case 'roa':
                    return value >= 15 ? 'positive' : value >= 10 ? 'neutral' : 'negative';
                case 'growth':
                    return value >= 10 ? 'positive' : value >= 5 ? 'neutral' : 'negative';
                case 'per':
                    return value <= 15 ? 'positive' : value <= 20 ? 'neutral' : 'negative';
                case 'pbr':
                    return value <= 2 ? 'positive' : value <= 3 ? 'neutral' : 'negative';
                default:
                    return 'neutral';
            }
        }

        function getRecommendationClass(recommendation) {
            if (['ì ê·¹ë§¤ìˆ˜', 'ë§¤ìˆ˜'].includes(recommendation)) return 'buy';
            if (['ë³´ìœ ', 'ê´€ì‹¬'].includes(recommendation)) return 'hold';
            return 'sell';
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showToast(title, message, type = 'info') {
            const toastElement = document.getElementById('alertToast');
            const titleElement = document.getElementById('toastTitle');
            const messageElement = document.getElementById('toastMessage');
            
            titleElement.textContent = title;
            messageElement.textContent = message;
            
            // íƒ€ì…ì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ë³€ê²½
            toastElement.className = `toast ${type === 'success' ? 'bg-success text-white' : type === 'danger' ? 'bg-danger text-white' : ''}`;
            
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }

        // KIS API ê´€ë ¨ í•¨ìˆ˜ë“¤
        function openKisApiModal() {
            const modal = new bootstrap.Modal(document.getElementById('kisApiModal'));
            modal.show();
        }

        async function testKisConnection() {
            const appKey = document.getElementById('kisAppKey').value.trim();
            const appSecret = document.getElementById('kisAppSecret').value.trim();
            const environment = document.getElementById('kisEnvironment').value;
            
            if (!appKey || !appSecret) {
                showToast('ì…ë ¥ ì˜¤ë¥˜', 'App Keyì™€ App Secretì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'danger');
                return;
            }
            
            try {
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appKey, appSecret, environment })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('ì—°ê²° ì„±ê³µ', data.message, 'success');
                    isKisConnected = true;
                    updateApiStatus(true);
                } else {
                    showToast('ì—°ê²° ì‹¤íŒ¨', data.message, 'danger');
                }
            } catch (error) {
                showToast('ì˜¤ë¥˜', 'ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        async function saveKisConfig() {
            const appKey = document.getElementById('kisAppKey').value.trim();
            const appSecret = document.getElementById('kisAppSecret').value.trim();
            const environment = document.getElementById('kisEnvironment').value;
            const accountNo = document.getElementById('kisAccountNo').value.trim();
            
            if (!appKey || !appSecret) {
                showToast('ì…ë ¥ ì˜¤ë¥˜', 'App Keyì™€ App Secretì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'danger');
                return;
            }
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appKey, appSecret, environment, accountNo })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('ì„¤ì • ì €ì¥', data.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('kisApiModal')).hide();
                } else {
                    showToast('ì €ì¥ ì‹¤íŒ¨', data.message, 'danger');
                }
            } catch (error) {
                showToast('ì˜¤ë¥˜', 'ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        function updateApiStatus(connected) {
            const statusElement = document.getElementById('apiStatus');
            if (connected) {
                statusElement.className = 'api-status connected';
                statusElement.innerHTML = '<span class="status-icon">ğŸŸ¢</span><span>KIS API ì—°ê²°ë¨</span>';
            } else {
                statusElement.className = 'api-status';
                statusElement.innerHTML = '<span class="status-icon">ğŸ”´</span><span>KIS API ì—°ê²° ì•ˆë¨</span>';
            }
        }

        async function updateAllPrices() {
            if (!isKisConnected) {
                showToast('API í•„ìš”', 'KIS API ì—°ê²° í›„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'warning');
                return;
            }
            
            const updateBtn = document.getElementById('updateBtn');
            const originalText = updateBtn.innerHTML;
            updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì—…ë°ì´íŠ¸ ì¤‘...';
            updateBtn.disabled = true;
            
            try {
                const response = await fetch('/api/update-all-prices');
                const data = await response.json();
                
                if (data.success) {
                    showToast('ì—…ë°ì´íŠ¸ ì™„ë£Œ', data.message, 'success');
                    loadStocks(); // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                } else {
                    showToast('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨', data.message, 'danger');
                }
            } catch (error) {
                showToast('ì˜¤ë¥˜', 'ê°€ê²© ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            } finally {
                updateBtn.innerHTML = originalText;
                updateBtn.disabled = false;
            }
        }

        async function updateSinglePrice(stockCode) {
            if (!isKisConnected) {
                showToast('API í•„ìš”', 'KIS API ì—°ê²° í›„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`/api/update-price/${stockCode}`);
                const data = await response.json();
                
                if (data.success) {
                    showToast('ê°€ê²© ì—…ë°ì´íŠ¸', data.message, 'success');
                    loadStocks(); // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                } else {
                    showToast('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨', data.message, 'danger');
                }
            } catch (error) {
                showToast('ì˜¤ë¥˜', 'ê°€ê²© ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        function showInvestmentCriteria() {
            const modal = new bootstrap.Modal(document.getElementById('criteriaModal'));
            modal.show();
        }

        async function exportData() {
            try {
                const url = `/api/export-stocks?style=${currentInvestor}&market=${currentMarket}`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = `investment_screener_${currentInvestor}_${currentMarket}_${new Date().toISOString().slice(0,10)}.csv`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(downloadUrl);
                    
                    showToast('ë‚´ë³´ë‚´ê¸° ì™„ë£Œ', 'CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    showToast('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨', 'ë°ì´í„° ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
                }
            } catch (error) {
                showToast('ì˜¤ë¥˜', 'ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
            }
        }

        // ì´ˆê¸° ë¡œë“œ
        loadStocks();
    </script>
</body>
</html>